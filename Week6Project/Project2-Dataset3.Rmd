---
title: "Project 2 - Dataset 3"
author: "E. Azrilyan and B. Sosnovski"
date: "10/04/2018"
output: 
  html_document: 
    theme: cerulean
---

```{r setup, include=FALSE, warning = FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Dataset

The data is obtained from the website BoxOfficeMojo, which has detailed data concerning the box office totals for on going movie releases.  

URL: https://www.boxofficemojo.com/alltime/world/

The website has information about the movies spread in 8 webpages.


# Tidying, transforming and analyzing Data

Information is read from BoxOfficeMojo into R.

We will perfom analyses in this project to answer the following questions:

* Do certain movie studios have a higher percentage of domestic grosses?

* Has the percentage of international grosses gone up recently (I'm defining "recent" this as the last decade or so)? 

* Have movies been getting more popular, grossing more money lately? 

_____________________________________________________________________

### Load packages
```{r}
library(knitr)
library(XML)
suppressMessages(library(RCurl))
suppressMessages(library(tidyverse))
```


### Function that creates a vector with all links to be accessed to retrieve data

```{r}
start_url <- "https://www.boxofficemojo.com/alltime/world/?pagenum="
end_url <- "&p=.htm"
# function
pages <- function(n){
        urls <- vector('character')
        for (i in 1:n){
                temp <- str_c(start_url,i,end_url, collapse = "")
                urls <- c(urls, temp)
        }
        return(urls)
}

urls <-pages(8)
urls
```

### Parsing data from web site

We create a dataframe with empty vectors to storage all the information that is going to be read from the website.

```{r}
movie_df <- data.frame(V1 = character(0), V2 = character(0), V3 = character(0), V4 = character(0), V5 = character(0), V6 = character(0), V7 = character(0), V8 = character(0), V9=character(0), stringsAsFactors = FALSE)

sapply(movie_df, class)
```

Now we retrieve the information from each page, parse it and append to the above dataframe.

Tyding the data will also be performed in this step, since the numerical data contains the symbols $, % and ^.

```{r}
for (i in 1:8){
        url <-urls[i]
        htmlData <- getURL(url)
        parsedData <-htmlParse(htmlData, encoding = "UTF-8")
        data <- readHTMLTable(parsedData, skip.rows =1 , stringsAsFactors = FALSE)
        table <- data[[2]]
        
        # combine dataframes
        movie_df <- suppressWarnings(bind_rows(movie_df, table)) 
}    

tbl_df(movie_df)
```

We identify the box office values in the thounsands and convert to millions.

For example, we want to extract the string "18.1" from "$18.1k", then convert to numeric and divide by 10000.

```{r}
for (k in c(4,5,6)){
        indices <- grep(".k$",movie_df[,k],value=F)
        if(length(indices)>0){
                values <- grep(".k$",movie_df[,k],value=T)
                cat("Before... ",values, "\n")
                tempVal <- unlist(str_extract_all(values,'[\\d\\.]+'))
                tempVal <- as.numeric(as.character(tempVal))
                tempVal <- as.character(tempVal/1000)
                cat("After... ",tempVal, "\n\n")
                movie_df[indices,k] <- tempVal
                print("This the result of the changes...")
                print(movie_df[indices,])
        }
}

```


Removing the symbols $, % and ^ from all the other columns and changing them to numeric type in R.

```{r}
for(j in seq(4,9)){
        movie_df[,j] <- suppressWarnings(as.numeric(gsub("[%,\\$\\^]","", movie_df[,j])))
}

sapply(movie_df, class)
```

And rename the columns of the movie_df.

```{r}
colnames(movie_df) <- c( "Rank", "Title" , "Studio", "Worldwide", "Domestic", "Domestic.Perc", "Overseas", "Overseas.Perc", "Year")
tbl_df(movie_df)
```
